<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gimnasio JM - Gestión de Reservas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav style="background-color: #0d6efd; padding: 10px; margin-bottom: 20px;">
  <div style="display: flex; justify-content: space-between; align-items: center; color: white;">
    <h3 style="margin: 0;">Gimnasio JM</h3>
    <div>
      <a href="/socios" style="color: white; text-decoration: none; margin-right: 15px; font-weight: bold;">Socios</a>
      <a href="/actividades" style="color: white; text-decoration: none; margin-right: 15px; font-weight: bold;">Actividades</a>
      <a href="/" style="color: white; text-decoration: none; font-weight: bold;">Reservas</a>
    </div>
  </div>
</nav>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Reserva de Turno GIMNASIO JM</h3>
                </div>
                <div class="card-body">
                    <form id="formReserva">
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Codigo del Socio:</label>
                                <input type="number" id="socio_id" class="form-control" placeholder="Ej: 1" required onblur="buscarSocio()">
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Nombre del Socio:</label>
                                <input type="text" id="socio_nombre" class="form-control bg-light" placeholder="Se cargará automáticamente..." readonly>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Actividad:</label>
                            <select name="actividad" id="selectActividad" class="form-select" required>
                                <option value="" disabled selected>Cargando actividades...</option>
                            </select>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Fecha:</label>
                                <input type="date" id="fecha" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Hora:</label>
                                <input type="time" id="hora" class="form-control" required>
                            </div>
                        </div>

                        <button type="submit" id="btnGuardar" class="btn btn-success w-100 btn-lg">
                            Confirmar Reserva
                        </button>
                    </form>

                    <div id="mensaje" class="alert mt-4 d-none" role="alert"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. AL CARGAR LA PÁGINA: Fecha y Cargar Actividades
    window.onload = function() {
        const ahora = new Date();
        const fechaLocal = new Date(ahora.getTime() - (ahora.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        document.getElementById('fecha').value = fechaLocal;
        document.getElementById('hora').value = ahora.toTimeString().slice(0,5);

        // Cargar Actividades
        fetch('/api/obtener-actividades')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('selectActividad');
                select.innerHTML = '<option value="" disabled selected>Seleccione una opción...</option>';
                data.forEach(actividad => {
                    const opcion = document.createElement('option');
                    opcion.value = actividad.id; // Asegúrate que tu BD tenga campo 'id'
                    opcion.textContent = actividad.nombre + ' (Cupo: ' + actividad.cupo_maximo + ')';
                    select.appendChild(opcion);
                });
            })
            .catch(error => console.error('Error al cargar actividades:', error));
    };

    // 2. BUSCADOR DE SOCIO
    async function buscarSocio() {
        const idInput = document.getElementById('socio_id');
        const nombreInput = document.getElementById('socio_nombre');
        const id = idInput.value;

        if (!id) return;

        nombreInput.value = "Buscando...";
        
        try {
            const respuesta = await fetch(`/api/socios/${id}`);
            if (respuesta.ok) {
                const socio = await respuesta.json();
                nombreInput.value = socio.nombre;
                nombreInput.classList.remove('is-invalid');
                nombreInput.classList.add('is-valid');
            } else {
                nombreInput.value = "❌ Socio no encontrado";
                nombreInput.classList.add('is-invalid');
            }
        } catch (error) {
            nombreInput.value = "Error de conexión";
        }
    }

    // 3. ENVÍO DEL FORMULARIO
    const form = document.getElementById('formReserva');
    const cajaMensaje = document.getElementById('mensaje');
    const btnGuardar = document.getElementById('btnGuardar');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        cajaMensaje.classList.add('d-none');
        btnGuardar.disabled = true;
        btnGuardar.innerText = "Guardando...";

        // CORREGIDO: Ahora buscamos por 'selectActividad', no 'actividad_id'
        const datos = {
            socio_id: document.getElementById('socio_id').value,
            actividad_id: document.getElementById('selectActividad').value, 
            fecha: document.getElementById('fecha').value,
            hora: document.getElementById('hora').value
        };

        try {
            // Enviamos a la ruta /api/reservas
            const respuesta = await fetch('/api/reservas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });

            const resultado = await respuesta.json();
            cajaMensaje.classList.remove('d-none');

            if (respuesta.ok) {
                cajaMensaje.className = 'alert mt-4 alert-success';
                cajaMensaje.innerHTML = `✅ ¡Reserva Exitosa!`;
                form.reset();
                document.getElementById('socio_nombre').value = "";
                // Recargamos fecha
                const ahora = new Date();
                document.getElementById('fecha').value = new Date(ahora.getTime() - (ahora.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            } else {
                cajaMensaje.className = 'alert mt-4 alert-danger';
                cajaMensaje.innerHTML = `⛔ ${resultado.mensaje || "Error al reservar"}`;
            }

        } catch (error) {
            cajaMensaje.classList.remove('d-none');
            cajaMensaje.className = 'alert mt-4 alert-warning';
            cajaMensaje.innerText = 'Error de conexión con el servidor.';
        } finally {
            btnGuardar.disabled = false;
            btnGuardar.innerText = "Confirmar Reserva";
        }
    });
</script>
</body>
</html>