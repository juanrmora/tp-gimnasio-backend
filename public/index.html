<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gimnasio - GestiÃ³n de Reservas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow-lg">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">ðŸ“… Nueva Reserva de Turno</h3>
                    </div>
                    <div class="card-body">
                        <form id="formReserva">
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Codigo del Socio:</label>
                                    <input type="number" id="socio_id" class="form-control" placeholder="Ej: 1" required onblur="buscarSocio()">
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Nombre del Socio:</label>
                                    <input type="text" id="socio_nombre" class="form-control bg-light" placeholder="Se cargarÃ¡ automÃ¡ticamente..." readonly>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Actividad:</label>
                                <select id="actividad_id" class="form-select" required>
                                    <option value="" selected disabled>Seleccione una opciÃ³n...</option>
                                    <option value="1">Pilates</option>
                                    <option value="2">Spinning</option>
                                  
                                </select>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Fecha:</label>
                                    <input type="date" id="fecha" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Hora:</label>
                                    <input type="time" id="hora" class="form-control" required>
                                </div>
                            </div>

                            <button type="submit" id="btnGuardar" class="btn btn-success w-100 btn-lg">
                                Confirmar Reserva
                            </button>
                        </form>

                        <div id="mensaje" class="alert mt-4 d-none" role="alert"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. AL CARGAR LA PÃGINA: Establecer Fecha y Hora actuales
        window.onload = function() {
            const ahora = new Date();
            
            // Formato fecha: YYYY-MM-DD
            // Ajustamos la zona horaria restando el offset en minutos
            const fechaLocal = new Date(ahora.getTime() - (ahora.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            document.getElementById('fecha').value = fechaLocal;

            // Formato hora: HH:MM
            const horaString = ahora.toTimeString().slice(0,5);
            document.getElementById('hora').value = horaString;
        };

        // 2. BUSCADOR DE SOCIO AUTOMÃTICO
        async function buscarSocio() {
            const idInput = document.getElementById('socio_id');
            const nombreInput = document.getElementById('socio_nombre');
            const id = idInput.value;

            if (!id) return; // Si estÃ¡ vacÃ­o no hacemos nada

            nombreInput.value = "Buscando...";
            nombreInput.classList.remove('text-danger');
            nombreInput.classList.add('text-muted');

            try {
                const respuesta = await fetch(`/api/socios/${id}`);
                if (respuesta.ok) {
                    const socio = await respuesta.json();
                    nombreInput.value = socio.nombre; // Â¡AquÃ­ ocurre la magia!
                    nombreInput.classList.remove('text-muted', 'is-invalid');
                    nombreInput.classList.add('is-valid', 'fw-bold');
                } else {
                    nombreInput.value = "âŒ Socio no encontrado";
                    nombreInput.classList.add('text-danger', 'is-invalid');
                }
            } catch (error) {
                console.error(error);
                nombreInput.value = "Error de conexiÃ³n";
            }
        }

        // 3. ENVÃO DEL FORMULARIO (Igual que antes)
        const form = document.getElementById('formReserva');
        const cajaMensaje = document.getElementById('mensaje');
        const btnGuardar = document.getElementById('btnGuardar');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            cajaMensaje.classList.add('d-none');
            btnGuardar.disabled = true;
            btnGuardar.innerText = "Guardando...";

            const datos = {
                socio_id: document.getElementById('socio_id').value,
                actividad_id: document.getElementById('actividad_id').value,
                fecha: document.getElementById('fecha').value,
                hora: document.getElementById('hora').value
            };

            try {
                const respuesta = await fetch('/api/reservas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const resultado = await respuesta.json();
                cajaMensaje.classList.remove('d-none');

                if (respuesta.ok) {
                    cajaMensaje.className = 'alert mt-4 alert-success';
                    cajaMensaje.innerHTML = `âœ… Â¡Reserva Exitosa!<br>Nro: ${resultado.id_reserva}`;
                    form.reset();
                    document.getElementById('socio_nombre').value = ""; // Limpiamos nombre tambiÃ©n
                    // Restablecemos la fecha/hora actual tras limpiar
                    window.onload(); 
                } else {
                    cajaMensaje.className = 'alert mt-4 alert-danger';
                    cajaMensaje.innerHTML = `â›” ${resultado.mensaje}`;
                    if(resultado.cupo_maximo) {
                        cajaMensaje.innerHTML += `<hr><small>Cupo: ${resultado.cupo_maximo} | Ocupado: ${resultado.reservas_actuales}</small>`;
                    }
                }

            } catch (error) {
                cajaMensaje.classList.remove('d-none');
                cajaMensaje.className = 'alert mt-4 alert-warning';
                cajaMensaje.innerText = 'Error de conexiÃ³n.';
            } finally {
                btnGuardar.disabled = false;
                btnGuardar.innerText = "Confirmar Reserva";
            }
        });
    </script>
</body>
</html>